docker_service_cpu: 1024
docker_service_memory: 2048
docker_service_autoscaling_prod:
    service_metric: ECSServiceAverageCPUUtilization
    target_value: 70
docker_service_autoscaling: "{{ docker_service_autoscaling_prod if APIGEE_ENVIRONMENT in ('ref', 'prod') else dict() }}"
docker_service_health_check_grace_period_seconds: 180
docker_service:
  - name: eps-coordinator
    port: 9000
    expose: true
    environment:
        - name: NODE_ENV
          value: production
        - name: LOG_LEVEL
          value: "{{ 'debug' if APIGEE_ENVIRONMENT == 'internal-dev' else 'info' }}"
        - name: SANDBOX
          value: "{{ SANDBOX_MODE_ENABLED }}"
        - name: BASE_PATH
          value: "https://{{ APIGEE_HOSTNAME }}/{{ SERVICE_BASE_PATH }}"
        - name: COMMIT_ID
          value: "{{ SOURCE_COMMIT_ID }}"
        - name: DEPLOYED_VERSION
          value: "{{ DEPLOYED_VERSION }}"
        - name: ENVIRONMENT
          value: "{{ APIGEE_ENVIRONMENT }}"
        - name: DISPENSE_ENABLED
          value: "true"
        - name: PRESCRIBE_ENABLED
          value: "true"
        - name: DOSE_TO_TEXT_MODE
          value: "AUDIT"
    secrets:
        - name: SPINE_URL
          valueFrom: '/{{ account }}/platform-common/egress/hosts/spine-prescriptions-{{ SPINE_ENV }}'
        - name: ODS_URL
          valueFrom: '/{{ account }}/platform-common/egress/hosts/directory-spineservices'
        - name: TO_ASID
          valueFrom: '/{{ account }}/api-deployment/{{ service_name }}/veit07.devspineservices.nhs.uk/to-asid'
        - name: TO_PARTY_KEY
          valueFrom: '/{{ account }}/api-deployment/{{ service_name }}/veit07.devspineservices.nhs.uk/to-party-key'
        - name: TRACKER_FROM_ASID
          valueFrom: '/{{ account }}/api-deployment/{{ service_name }}/veit07.devspineservices.nhs.uk/tracker-from-asid'
        - name: TRACKER_TO_ASID
          valueFrom: '/{{ account }}/api-deployment/{{ service_name }}/veit07.devspineservices.nhs.uk/tracker-to-asid'
    health_check:
        matcher: "200"
        path: "/_healthcheck"
  - name: eps-validator
    port: 9001
    expose: false
    health_check:
        matcher: "200"
        path: "/_status"
  - name: sds-api
    port: 9002
    expose: false
    environment:
      - name: SDS_LOG_LEVEL
        value: NOTSET
      - name: SDS_LDAP_SEARCH_BASE
        value: ou=services,o=nhs
      - name: SDS_LDAP_URL
        value: ldap.nis1.national.ncrs.nhs.uk
      - name: SDS_SPINE_CORE_ODS_CODE
        value: "YES"
    secrets:
      - name: SDS_SECRET_CLIENT_KEY
        valueFrom: "arn:aws:secretsmanager:eu-west-2:{{ PTL_ACCOUNT_ID }}:secret:ptl/cis/ldap.nis1.national.ncrs.nhs.uk/key"
      - name: SDS_SECRET_CLIENT_CERT
        valueFrom: "arn:aws:secretsmanager:eu-west-2:{{ PTL_ACCOUNT_ID }}:secret:ptl/cis/ldap.nis1.national.ncrs.nhs.uk/crt"
      - name: SDS_SECRET_CA_CERTS
        valueFrom: "arn:aws:secretsmanager:eu-west-2:{{ PTL_ACCOUNT_ID }}:secret:ptl/ca-certs/nhsd-ptl/root-ca/crt"
    health_check:
      matcher: "200"
      path: "/healthcheck"